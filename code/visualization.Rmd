---
title: "Visualization"
author: "Ruby"
date: "2023-12-28"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#load package
library(ggplot2)
library(dplyr)
library(car)
library(mfp)
library(lspline)
library(rms)

```



```{r}
#read data
dt <- read.csv("../clean/clean_dt.csv")
table(dt$FFQ0102)

```


```{r}
hist(dt$INDFMPIR)
dt$PIR <- 0
dt[dt$INDFMPIR >= 2, "PIR"] <- 1
table(dt$PIR)
hist(dt$FFQ0102)
```
```{r}
topval <- 11

themedian <- c()
oddslist <- c()
poscount <- c()
negcount <- c()

for (j in 1:topval) {
  temp_median <- mean(dt$FFQ0102[dt$FFQ0102==j])
  
  temp_pos <- nrow(dt[dt$FFQ0102==j & dt$PIR==1, ])
  
  temp_neg <- nrow(dt[dt$FFQ0102==j & dt$PIR==0, ])
  
  temp_prob <- mean(dt$PIR[dt$FFQ0102==j])
  temp_odds <- temp_prob/(1-temp_prob)
  themedian <- c(themedian, temp_median)
  poscount <- c(poscount, temp_pos)
  negcount <- c(negcount, temp_neg)
  oddslist <- c(oddslist, temp_odds)
}


lci_odds <- oddslist / (exp(qnorm(0.975)*sqrt(1/poscount)+(1/negcount)))
uci_odds <- oddslist * (exp(qnorm(0.975)*sqrt(1/poscount)+(1/negcount)))

grp_102 <- seq(1, topval, by = 1)
obsdata <- cbind(grp_102, themedian, negcount, poscount, oddslist, lci_odds, uci_odds)
obsdata <- data.frame(obsdata)

ggplot() +
  geom_pointrange(data = obsdata, mapping = aes(x = themedian, y = oddslist, ymin = lci_odds, ymax = uci_odds)) +
  scale_y_continuous(trans = 'log', limits = c(min(obsdata$lci_odds), max(obsdata$uci_odds)))

```


```{r}
#linear model
model_linear <- glm(PIR~FFQ0102, data = dt, family = binomial(link = "logit"))
summary(model_linear)
exp(cbind(coef(model_linear), confint(model_linear)))

```

```{r}
dt$linpred_logodds <- predict(model_linear)
dt$linpred_odds <- exp(dt$linpred_logodds)

ggplot() +
  geom_pointrange(data = obsdata, mapping = aes(x=themedian, y=oddslist, ymin=lci_odds, ymax=uci_odds)) +
  scale_y_continuous(trans = 'log', limits = c(min(obsdata$lci_odds), max(obsdata$uci_odds))) +
  geom_line(data = dt, aes(x=FFQ0102, y=linpred_odds, color="Linear"), color="blue") +
  xlab("Frequency of eating potato chips") +
  ylab("odds of PIR")
```



```{r}
dt$FFQ0102_sq <- dt$FFQ0102^2

model_quad <- glm(PIR~FFQ0102 + FFQ0102_sq, data = dt, family = binomial(link = "logit"))
summary(model_quad)
exp(cbind(coef(model_quad), confint(model_quad)))
```

```{r}
dt$quadpred_logodds <- predict(model_quad)
dt$quadpred_odds <- exp(dt$quadpred_logodds)


ggplot() +
  geom_pointrange(data = obsdata, mapping = aes(x=themedian, y=oddslist, ymin=lci_odds, ymax=uci_odds)) +
  scale_y_continuous(trans = 'log', limits = c(min(obsdata$lci_odds), max(obsdata$uci_odds))) +
  geom_line(data = dt, aes(x=FFQ0102, y=linpred_odds, color="Linear"), color="blue") +
  geom_line(data = dt, aes(x=FFQ0102, y=quadpred_odds, color="Quadratic"), color="red") +
  xlab("Frequency of eating potato chips") +
  ylab("odds of PIR")
```

```{r}
#frctional polynomial
model_fp <- mfp(PIR~fp(FFQ0102, df=4, select=0.05), family = binomial, data = dt)
summary(model_fp)
```

```{r}
dt$fp_pred <- exp(predict(model_fp))
colors1 <- c("Linear" = "blue", "Quadratic" = "red", "FP" = "green")

ggplot() +
  geom_pointrange(data = obsdata, mapping = aes(x=themedian, y=oddslist, ymin=lci_odds, ymax=uci_odds)) +
  scale_y_continuous(trans = 'log', limits = c(min(obsdata$lci_odds), max(obsdata$uci_odds))) +
  geom_line(data = dt, aes(x=FFQ0102, y=linpred_odds, color="Linear")) +
  geom_line(data = dt, aes(x=FFQ0102, y=quadpred_odds, color="Quadratic")) +
  geom_line(data = dt, aes(x=FFQ0102, y=fp_pred, color = "FP")) +
  xlab("Frequency of eating potato chips") +
  ylab("odds of PIR") +
  scale_color_manual(values = colors1)
```

```{r}
#Linear splines (knots at 3 and 6)
model_linsp <- glm(PIR~lspline(FFQ0102, knots =c(3,6)), family = binomial, data = dt)
summary(model_linsp)
```

```{r}
dt$linsp_pred <- exp(predict(model_linsp))


colors1 <- c("Linear" = "lightblue2", "Quadratic" = "yellow3", "FP" = "green4", "Linearspline" = "pink2")

ggplot() +
  geom_pointrange(data = obsdata, mapping = aes(x=themedian, y=oddslist, ymin=lci_odds, ymax=uci_odds)) +
  scale_y_continuous(trans = 'log', limits = c(min(obsdata$lci_odds), max(obsdata$uci_odds))) +
  geom_line(data = dt, aes(x=FFQ0102, y=linpred_odds, color="Linear")) +
  geom_line(data = dt, aes(x=FFQ0102, y=quadpred_odds, color="Quadratic")) +
  geom_line(data = dt, aes(x=FFQ0102, y=fp_pred, color = "FP")) +
  geom_line(data = dt, aes(x=FFQ0102, y=linsp_pred, color = "Linearspline")) +
  xlab("Frequency of eating potato chips") +
  ylab("odds of PIR") +
  scale_color_manual(values = colors1)
```


```{r}
model_cubicsp <- glm(PIR~rcs(FFQ0102,3), family = binomial, data = dt)

dt$cubicsp_pred <- exp(predict(model_cubicsp))


colors1 <- c("Linear" = "lightblue2", "Quadratic" = "yellow3", "FP" = "green4", "Linearspline" = "pink2", "cubic_spline" = "red3")

ggplot() +
  geom_pointrange(data = obsdata, mapping = aes(x=themedian, y=oddslist, ymin=lci_odds, ymax=uci_odds)) +
  scale_y_continuous(trans = 'log', limits = c(min(obsdata$lci_odds), max(obsdata$uci_odds))) +
  geom_line(data = dt, aes(x=FFQ0102, y=linpred_odds, color="Linear")) +
  geom_line(data = dt, aes(x=FFQ0102, y=quadpred_odds, color="Quadratic")) +
  geom_line(data = dt, aes(x=FFQ0102, y=fp_pred, color = "FP")) +
  geom_line(data = dt, aes(x=FFQ0102, y=linsp_pred, color = "Linearspline")) + geom_line(data = dt, aes(x=FFQ0102, y=cubicsp_pred, color = "cubic_spline")) +
  xlab("Frequency of eating potato chips") +
  ylab("odds of PIR") +
  scale_color_manual(values = colors1)
```

```{r}
AIC(model_linear)
AIC(model_quad)
AIC(model_fp)
AIC(model_linsp)
AIC(model_cubicsp)
#From AIC test, fractional polynomial is the best fit for this model.
```

```{r}
write.csv(dt,"../clean/pir_model_dt.csv", row.names = FALSE)
```

```{r}
write.csv(obsdata, "../clean/pir_odds_dt.csv", row.names = FALSE)
```

